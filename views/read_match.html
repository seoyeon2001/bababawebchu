<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous"/>
    <link rel="stylesheet" type="text/css" href="/stylesheets/index_style.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"/>
    <title>PangPang</title>
    <script>      
      fetch('/navbar')
        .then(response => {return response.text()})
          .then(data => {document.getElementById("content").innerHTML = data;})
          .catch(error => console.error('Error:', error));
    </script>
  </head>

  <body>
    <!-- 네비게이션바 -->
    <div id='content'></div>
    
    <!--빵 부스러기 (Breadcrumb)-->
    <main class="mt-3 pt-1">
      <div class="container-fluid">
        <div class="row">
          <div class="col-md-12">
            <i class="bi bi-house-fill"> / 매치 / 전체 매치</i>
          </div> 
        </div>
      </div>
    </main>

    <!--사이드바 -->
    <div id="page-wrapper">
      <div id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-brand">
            <a href="/match" style="font-size: 1.5em;">매치</a>
          </li>
          <li><a href="/match" class="underline-on">전체 매치</a></li>
          <li><a href="/match/write">매치 게시물 작성</a></li>
          <li><a href="/info/stadium">경기장 정보</a></li>
        </ul>
      </div>
      <hr class="my-4" style="height: 3px; background-color: #006f3e;">
      
    <!--매치글 조회-->
    <div class="container">
      <hr/>
      <div class="row">
        <div class="col-md-10">
          <div id=comments></div>
            <table class="table table-condensed">
              <thead>
                <tr>
                  <td>
                    <span style='float:right'>
                        <a href="/match" class="btn btn-success">목록</a>
                        <a href="/match/edit" class="btn btn-success">수정</a>
                        <a href="" class="btn btn-success">삭제</a>
                        <a href="/match/write" class="btn btn-success">글쓰기</a>
                    </span>
                  </td>
                </tr>
              </thead>
            </table>
        </div>
      </div>
        <table class="table table-condensed">
          <thead>
            <tr>
              <th>제목</th>
              <td>{{match.title}}</td>
            </tr>
          </thead>
          <tbody>
            <tr>
              <th>모집 상태</th>
              <td>{{match.state}}</td>
            </tr>
            <tr>
            <tr>
              <th>작성자</th>
              <td>{{match.writer}}</td>
            </tr>
            <tr>
              <th>작성일</th>
              <td>{{match.createdAt}}</td>
            </tr>
            <tr>
              <th>종목</th>
              <td>{{match.sport}}</td>
            </tr>
            <tr>
              <th>장소</th>
              <td>{{match.location}}</td>
            </tr>
            <tr>
              <th>모집인원</th>
              <td>{{match.people}}</td>
            </tr>
            <tr>
              <th>참가비</th>
              <td>{{match.price}}</td>
            </tr>
            <tr>
              <th>성별</th>
              <td>{{match.gender}}</td>
            </tr>
            <tr>
              <th>내용</th>
              <td>{{match.content}}</td>
            </tr>
          </tbody>
        </table>
        <div id="form-commentInfo">
          <div id="comment-count">댓글 <span id="count"></span></div>
          <input id="comment-input" placeholder="댓글을 입력해 주세요.">
          <button id="commentSubmit" class="btn btn-success">등록</button>
        </div>
        <hr/>
        <table class="table">
          <thead>
            <tr>
              <th scope="col">댓글 내용</th>
              <th scope="col">작성자</th>
            </tr>
          </thead>
          <tbody id="showcomment"></tbody>
        </table>
        <hr/>
    </div>    

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" crossorigin="anonymous"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        checkAuthentication(); // 페이지 로드 시 토큰 확인
        getComment(); // 페이지 로드 시 댓글 로드
      });

      // 사용자의 인증 여부를 확인하는 함수
      function checkAuthentication() {
        const token = sessionStorage.getItem('토큰');

        if (!token) {
          // 토큰이 없으면 로그인 화면으로 리다이렉트
          alert('로그인이 필요합니다.');
          window.location.href = '/users/login'; // 로그인 화면으로 리다이렉트
        }
      }

      // 댓글 쓰기
      document.getElementById('commentSubmit').addEventListener('click', () => {
        const token = sessionStorage.getItem('토큰');
        const comment = document.getElementById('comment-input').value;
        const matchId = window.location.pathname.split('/').pop();

        if (comment === '') {
          alert('댓글을 입력해 주세요.');
          return;
        }
        
        fetch("/users/getid", {
          method: 'GET',
          headers: {
            'authorization': `${token}`,
            'Content-Type': 'application/json'
          },
        })
        .then(response => response.json())
        .then(data => { 
          const writer = data.user_id; // 작성자
          const commentdata = {comment, matchId, writer};

          fetch('/comment/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(commentdata),
          })
          .then(response => { return response.json() })
          .then(data => { 
            if (data.success) {
              alert('댓글이 등록되었습니다.');
              location.reload();
            } else {
              alert('댓글 등록에 실패하였습니다.');
            }
          })
          .catch((error) => {
            console.error('Error:', error);
          });
        })
        .catch(error => console.error('Error:', error));
      });
    
      function getComment() {
        const matchId = window.location.pathname.split('/').pop();

        fetch('/comment/' + matchId, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          },
        })
        .then(response => { return response.json() })
        .then(data => { 
          if (data.success) {
            const comments = data.comments;
            const count = comments.length;
            document.getElementById('count').innerText = count;

            const showcomment = document.getElementById('showcomment'); 
            showcomment.innerHTML = ''; // 기존 리스트 초기화

            comments.forEach(comment => {
              const row = document.createElement('tr');

              const commentCell = document.createElement('td');
              commentCell.textContent = comment.comment;
              row.appendChild(commentCell);

              const writerCell = document.createElement('td');
              writerCell.textContent = comment.writer;
              row.appendChild(writerCell);

              showcomment.appendChild(row);
              
            });
          } else {
            alert('댓글 로드에 실패하였습니다.');
          }
        })
        .catch((error) => {
          console.error('Error:', error);
        });
      }

    </script>
  </body>
</html>